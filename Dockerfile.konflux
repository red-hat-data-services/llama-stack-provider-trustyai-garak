FROM registry.access.redhat.com/ubi9/python-312@sha256:f90710e94f67ec27e1f91de9851a3b9bf34e786a1ad3b567c2a39e0867cf00b5
WORKDIR /opt/app-root

USER root

# For Rust-based Python packages
RUN dnf install -y --setopt install_weak_deps=0 --nodocs \
    cargo \
    rust \
    && dnf clean all

COPY . .

# Build argument to specify architecture
ARG TARGETARCH=x86_64

# Install dependencies
RUN echo "Installing $TARGETARCH dependencies ..." && \
    if [ -d /cachi2/output/deps/cargo ]; then \
        export CARGO_HOME=/root/.cargo; \
        mkdir -p "$CARGO_HOME" && \
        printf '%s\n' \
            '[source.crates-io]' \
            'replace-with = "vendored-sources"' \
            '' \
            '[source.vendored-sources]' \
            'directory = "/cachi2/output/deps/cargo"' \
            > "$CARGO_HOME/config.toml"; \
        export CARGO_NET_OFFLINE=true; \
        echo "Using prefetched cargo deps from /cachi2/output/deps/cargo"; \
    fi && \
    echo "Debug: CARGO_HOME=${CARGO_HOME:-<unset>} CARGO_NET_OFFLINE=${CARGO_NET_OFFLINE:-<unset>}" && \
    if [ "$TARGETARCH" = "amd64" ] || [ "$TARGETARCH" = "x86_64" ]; then \
        pip install --no-cache-dir -r requirements-x86_64.txt; \
    elif [ "$TARGETARCH" = "arm64" ] || [ "$TARGETARCH" = "aarch64" ]; then \
        pip install --no-cache-dir -r requirements-aarch64.txt; \
    elif [ "$TARGETARCH" = "s390x" ] || [ "$TARGETARCH" = "ppc64le" ]; then \
	dnf install -y gcc ninja-build \
         && pip install --no-cache-dir -r .konflux/${TARGETARCH}/requirements.txt; \
    else \
        echo "ERROR: Unsupported architecture: $TARGETARCH"; \
        exit 1; \
    fi

# Install the package itself (--no-deps since dependencies already installed)
RUN pip install --no-cache-dir --no-deps -e ".[inline]"

# Set XDG environment variables to use /tmp (always writable) for garak to write to
ENV XDG_CACHE_HOME=/tmp/.cache
ENV XDG_DATA_HOME=/tmp/.local/share
ENV XDG_CONFIG_HOME=/tmp/.config

LABEL com.redhat.component="odh-trustyai-garak-lls-provider-dsp-rhel9" \
      name="rhoai/odh-trustyai-garak-lls-provider-dsp-rhel9" \
      description="TrustyAI Garak Llama Stack Provider for DSP" \
      summary="odh-trustyai-garak-lls-provider-dsp" \
      maintainer="['managed-open-data-hub@redhat.com']" \
      io.openshift.expose-services="" \
      io.k8s.display-name="odh-trustyai-garak-lls-provider-dsp" \
      io.k8s.description="odh-trustyai-garak-lls-provider-dsp" \
      com.redhat.license_terms="https://www.redhat.com/licenses/Red_Hat_Standard_EULA_20191108.pdf"
